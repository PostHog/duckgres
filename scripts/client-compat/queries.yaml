# Shared catalog introspection queries for client compatibility testing.
#
# Every client runner loads this file, executes each query, and reports
# pass/fail to the results gatherer.
#
# Fields:
#   suite     - test grouping (catalog_views, catalog_funcs, etc.)
#   name      - unique test name within the suite
#   sql       - the query to execute (must succeed without error)
#   stub      - (optional) true if the function/view returns a hardcoded
#               dummy value rather than meaningful data

# --- pg_catalog views ---
- suite: catalog_views
  name: pg_database
  stub: true
  sql: SELECT datname FROM pg_database WHERE datallowconn

- suite: catalog_views
  name: pg_namespace
  sql: SELECT nspname FROM pg_namespace

- suite: catalog_views
  name: pg_type
  sql: SELECT typname, typtype FROM pg_type LIMIT 10

- suite: catalog_views
  name: pg_class
  sql: SELECT relname, relkind FROM pg_class WHERE relkind = 'r' LIMIT 10

- suite: catalog_views
  name: pg_attribute
  sql: SELECT attname, atttypid FROM pg_attribute WHERE attnum > 0 LIMIT 10

- suite: catalog_views
  name: pg_roles
  stub: true
  sql: SELECT rolname FROM pg_roles

- suite: catalog_views
  name: pg_database_filtered
  stub: true
  sql: >-
    SELECT datname FROM pg_database
    WHERE datistemplate IS false AND datallowconn IS true
    ORDER BY datname

# --- pg_catalog functions/macros ---
- suite: catalog_funcs
  name: format_type
  sql: SELECT format_type(23, -1)

- suite: catalog_funcs
  name: format_type_varchar
  sql: SELECT format_type(1043, 54)

- suite: catalog_funcs
  name: format_type_numeric
  sql: SELECT format_type(1700, 655366)

- suite: catalog_funcs
  name: pg_get_userbyid
  stub: true
  sql: SELECT pg_get_userbyid(10)

- suite: catalog_funcs
  name: pg_table_is_visible
  stub: true
  sql: SELECT pg_table_is_visible(0)

- suite: catalog_funcs
  name: has_schema_privilege
  stub: true
  sql: SELECT has_schema_privilege('public', 'USAGE')

- suite: catalog_funcs
  name: has_table_privilege
  stub: true
  sql: SELECT has_table_privilege('pg_class', 'SELECT')

- suite: catalog_funcs
  name: pg_encoding_to_char
  stub: true
  sql: SELECT pg_encoding_to_char(6)

- suite: catalog_funcs
  name: version
  stub: true
  sql: SELECT version()

- suite: catalog_funcs
  name: current_setting
  stub: true
  sql: SELECT current_setting('server_version')

- suite: catalog_funcs
  name: obj_description
  stub: true
  sql: SELECT obj_description(0, 'pg_class')

- suite: catalog_funcs
  name: col_description
  stub: true
  sql: SELECT col_description(0, 1)

- suite: catalog_funcs
  name: pg_get_expr
  stub: true
  sql: SELECT pg_get_expr(NULL, 0)

- suite: catalog_funcs
  name: pg_get_indexdef
  stub: true
  sql: SELECT pg_get_indexdef(0)

- suite: catalog_funcs
  name: pg_get_constraintdef
  stub: true
  sql: SELECT pg_get_constraintdef(0)

- suite: catalog_funcs
  name: pg_get_serial_sequence
  stub: true
  sql: SELECT pg_get_serial_sequence('pg_class', 'oid')

- suite: catalog_funcs
  name: shobj_description
  stub: true
  sql: SELECT shobj_description(0, 'pg_database')

- suite: catalog_funcs
  name: pg_total_relation_size
  stub: true
  sql: SELECT pg_total_relation_size(0)

- suite: catalog_funcs
  name: pg_relation_size
  stub: true
  sql: SELECT pg_relation_size(0)

- suite: catalog_funcs
  name: pg_table_size
  stub: true
  sql: SELECT pg_table_size(0)

- suite: catalog_funcs
  name: pg_indexes_size
  stub: true
  sql: SELECT pg_indexes_size(0)

- suite: catalog_funcs
  name: pg_database_size
  stub: true
  sql: SELECT pg_database_size('main')

- suite: catalog_funcs
  name: quote_nullable
  sql: SELECT quote_nullable('hello')

- suite: catalog_funcs
  name: txid_current
  stub: true
  sql: SELECT txid_current()

- suite: catalog_funcs
  name: pg_is_in_recovery
  stub: true
  sql: SELECT pg_is_in_recovery()

- suite: catalog_funcs
  name: pg_backend_pid
  stub: true
  sql: SELECT pg_backend_pid()

- suite: catalog_funcs
  name: pg_size_pretty
  sql: SELECT pg_size_pretty(1048576)

- suite: catalog_funcs
  name: quote_ident
  sql: SELECT quote_ident('my_table')

- suite: catalog_funcs
  name: quote_literal
  sql: SELECT quote_literal('hello')

# --- information_schema views ---
- suite: info_schema
  name: tables
  sql: SELECT table_name, table_type FROM information_schema.tables LIMIT 10

- suite: info_schema
  name: columns
  sql: >-
    SELECT table_name, column_name, data_type
    FROM information_schema.columns LIMIT 10

- suite: info_schema
  name: schemata
  sql: SELECT schema_name FROM information_schema.schemata

- suite: info_schema
  name: schemata_filtered
  sql: >-
    SELECT schema_name FROM information_schema.schemata
    WHERE schema_name != 'information_schema'
    AND schema_name NOT LIKE 'pg_%'
    ORDER BY schema_name

# --- multi-table joins that real tools send ---
- suite: catalog_joins
  name: pg_class_join_namespace
  sql: >-
    SELECT n.nspname, c.relname, c.relkind
    FROM pg_class c
    JOIN pg_namespace n ON c.relnamespace = n.oid
    WHERE n.nspname NOT IN ('pg_catalog', 'information_schema')
    ORDER BY n.nspname, c.relname
    LIMIT 20

- suite: catalog_joins
  name: pg_attribute_join_format_type
  sql: >-
    SELECT a.attname, pg_catalog.format_type(a.atttypid, a.atttypmod)
    FROM pg_attribute a
    JOIN pg_class t ON a.attrelid = t.oid
    JOIN pg_namespace s ON t.relnamespace = s.oid
    WHERE a.attnum > 0 AND NOT a.attisdropped
    AND s.nspname NOT IN ('pg_catalog', 'information_schema')
    ORDER BY a.attnum
    LIMIT 20

- suite: catalog_joins
  name: list_tables
  sql: >-
    SELECT n.nspname as "Schema",
    c.relname as "Name",
    CASE c.relkind WHEN 'r' THEN 'table' WHEN 'v' THEN 'view' END as "Type",
    pg_catalog.pg_get_userbyid(c.relowner) as "Owner"
    FROM pg_catalog.pg_class c
    LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
    WHERE c.relkind IN ('r','v')
    AND n.nspname NOT IN ('pg_catalog', 'information_schema')
    ORDER BY 1, 2
    LIMIT 20

- suite: catalog_joins
  name: list_schemas
  sql: >-
    SELECT n.nspname AS "Name",
    pg_catalog.pg_get_userbyid(n.nspowner) AS "Owner"
    FROM pg_catalog.pg_namespace n
    WHERE n.nspname !~ '^pg_' AND n.nspname <> 'information_schema'
    ORDER BY 1

- suite: catalog_joins
  name: list_databases
  sql: >-
    SELECT d.datname as "Name",
    pg_catalog.pg_get_userbyid(d.datdba) as "Owner",
    pg_catalog.pg_encoding_to_char(d.encoding) as "Encoding"
    FROM pg_catalog.pg_database d
    ORDER BY 1

# --- stub views (should return empty, not error) ---
- suite: catalog_stubs
  name: pg_matviews
  stub: true
  sql: SELECT matviewname FROM pg_matviews

- suite: catalog_stubs
  name: pg_policy
  stub: true
  sql: SELECT * FROM pg_policy LIMIT 5

- suite: catalog_stubs
  name: pg_collation
  stub: true
  sql: SELECT collname FROM pg_collation LIMIT 5

- suite: catalog_stubs
  name: pg_statistic_ext
  stub: true
  sql: SELECT * FROM pg_statistic_ext LIMIT 5

- suite: catalog_stubs
  name: pg_publication
  stub: true
  sql: SELECT * FROM pg_publication LIMIT 5

- suite: catalog_stubs
  name: pg_inherits
  stub: true
  sql: SELECT * FROM pg_inherits LIMIT 5

- suite: catalog_stubs
  name: pg_rules
  stub: true
  sql: SELECT * FROM pg_rules LIMIT 5

- suite: catalog_stubs
  name: pg_stat_statements
  stub: true
  sql: SELECT * FROM pg_stat_statements LIMIT 5

- suite: catalog_stubs
  name: pg_partitioned_table
  stub: true
  sql: SELECT * FROM pg_partitioned_table LIMIT 5

- suite: catalog_stubs
  name: pg_constraint
  stub: true
  sql: SELECT * FROM pg_constraint LIMIT 5

- suite: catalog_stubs
  name: pg_enum
  stub: true
  sql: SELECT * FROM pg_enum LIMIT 5

- suite: catalog_stubs
  name: pg_indexes
  stub: true
  sql: SELECT * FROM pg_indexes LIMIT 5

- suite: catalog_stubs
  name: pg_stat_activity
  stub: true
  sql: SELECT * FROM pg_stat_activity LIMIT 5

- suite: catalog_stubs
  name: pg_stat_user_tables
  sql: SELECT relname FROM pg_stat_user_tables LIMIT 5

- suite: catalog_stubs
  name: pg_publication_rel
  stub: true
  sql: SELECT * FROM pg_publication_rel LIMIT 5

- suite: catalog_stubs
  name: pg_statio_user_tables
  sql: SELECT * FROM pg_statio_user_tables LIMIT 5

# --- DBeaver introspection queries ---
# Queries that DBeaver CE fires on connect for metadata discovery.
# Sourced from https://github.com/cockroachdb/cockroach/issues/28309
# which catalogued every introspection query DBeaver sends.
#
# These test the same catalog surface that a real DBeaver connection
# would exercise. We cannot run DBeaver headlessly (GTK3 SWT bug
# freezes the event loop under Xvfb) so we test the queries directly.

# Database list
- suite: dbeaver_introspection
  name: database_list
  stub: true
  sql: SELECT db.datname FROM pg_catalog.pg_database AS db WHERE datallowconn

# Role list
- suite: dbeaver_introspection
  name: role_list
  stub: true
  sql: SELECT a.oid, a.* FROM pg_catalog.pg_roles AS a

# Access methods
- suite: dbeaver_introspection
  name: pg_am
  stub: true
  sql: SELECT am.oid, am.* FROM pg_catalog.pg_am AS am

# Collations
- suite: dbeaver_introspection
  name: pg_collation
  stub: true
  sql: SELECT c.oid, c.* FROM pg_catalog.pg_collation AS c

# Tablespaces
- suite: dbeaver_introspection
  name: pg_tablespace
  stub: true
  sql: SELECT t.oid, t.* FROM pg_catalog.pg_tablespace AS t

# Schemas with descriptions
- suite: dbeaver_introspection
  name: schemas_with_desc
  stub: true
  sql: >-
    SELECT n.oid, n.*, d.description
    FROM pg_catalog.pg_namespace AS n
    LEFT JOIN pg_catalog.pg_description AS d ON d.objoid = n.oid

# Sequences
- suite: dbeaver_introspection
  name: pg_sequences
  stub: true
  sql: SELECT * FROM pg_catalog.pg_sequences LIMIT 5

# Enums
- suite: dbeaver_introspection
  name: pg_enum
  stub: true
  sql: SELECT e.enumlabel FROM pg_catalog.pg_enum AS e LIMIT 5

# Classes (tables/views) with descriptions â€” DBeaver's main catalog query
- suite: dbeaver_introspection
  name: classes_with_desc
  stub: true
  sql: >-
    SELECT c.oid, c.relname, c.relkind, c.relnamespace, d.description
    FROM pg_catalog.pg_class AS c
    LEFT JOIN pg_catalog.pg_description AS d ON d.objoid = c.oid AND d.objsubid = 0
    WHERE c.relkind NOT IN ('i', 'c')
    LIMIT 20

# Attributes (columns) with defaults and descriptions
- suite: dbeaver_introspection
  name: attributes_with_defaults
  sql: >-
    SELECT c.relname, a.attname, a.atttypid, a.attnum,
    pg_catalog.pg_get_expr(ad.adbin, ad.adrelid, true) AS def_value,
    dsc.description
    FROM pg_catalog.pg_attribute AS a
    INNER JOIN pg_catalog.pg_class AS c ON a.attrelid = c.oid
    LEFT JOIN pg_catalog.pg_attrdef AS ad ON a.attrelid = ad.adrelid AND a.attnum = ad.adnum
    LEFT JOIN pg_catalog.pg_description AS dsc ON c.oid = dsc.objoid AND a.attnum = dsc.objsubid
    WHERE a.attnum > 0 AND NOT a.attisdropped
    LIMIT 20

# Constraints with table names
- suite: dbeaver_introspection
  name: constraints_with_tables
  stub: true
  sql: >-
    SELECT c.oid, c.conname, c.contype, t.relname AS tabrelname,
    rt.relnamespace AS refnamespace, d.description
    FROM pg_catalog.pg_constraint AS c
    INNER JOIN pg_catalog.pg_class AS t ON t.oid = c.conrelid
    LEFT JOIN pg_catalog.pg_class AS rt ON rt.oid = c.confrelid
    LEFT JOIN pg_catalog.pg_description AS d ON d.objoid = c.oid AND d.objsubid = 0
    LIMIT 20

# Indexes with descriptions
- suite: dbeaver_introspection
  name: indexes_with_desc
  stub: true
  sql: >-
    SELECT i.indexrelid, i.indrelid, i.indisunique, i.indisprimary,
    c.relname, tc.relname AS tabrelname, dsc.description
    FROM pg_catalog.pg_index AS i
    INNER JOIN pg_catalog.pg_class AS c ON c.oid = i.indexrelid
    INNER JOIN pg_catalog.pg_class AS tc ON tc.oid = i.indrelid
    LEFT JOIN pg_catalog.pg_description AS dsc ON i.indexrelid = dsc.objoid
    LIMIT 20

# Procedures (functions)
- suite: dbeaver_introspection
  name: pg_proc
  sql: >-
    SELECT p.oid, p.proname, p.pronamespace, p.prorettype
    FROM pg_catalog.pg_proc AS p
    LIMIT 20

# Data types (filtered)
- suite: dbeaver_introspection
  name: pg_type_filtered
  sql: >-
    SELECT t.oid, t.typname, t.typnamespace, t.typtype, t.typcategory
    FROM pg_catalog.pg_type AS t
    WHERE t.typcategory NOT IN ('A', 'C')
    LIMIT 20

# Inheritance
- suite: dbeaver_introspection
  name: pg_inherits
  stub: true
  sql: >-
    SELECT i.*, c.relnamespace
    FROM pg_catalog.pg_inherits AS i, pg_catalog.pg_class AS c
    WHERE c.oid = i.inhparent
    LIMIT 5

# Activity
- suite: dbeaver_introspection
  name: pg_stat_activity
  stub: true
  sql: SELECT sa.* FROM pg_catalog.pg_stat_activity AS sa LIMIT 5

# Object comments
- suite: dbeaver_introspection
  name: object_comments
  stub: true
  sql: >-
    SELECT description
    FROM pg_catalog.pg_description
    JOIN pg_catalog.pg_class ON pg_description.objoid = pg_class.oid
    JOIN pg_catalog.pg_namespace ON pg_class.relnamespace = pg_namespace.oid
    LIMIT 5

# View definition function
- suite: dbeaver_introspection
  name: pg_get_viewdef
  stub: true
  sql: SELECT pg_get_viewdef(0)

# View definition function (pretty-print overload)
- suite: dbeaver_introspection
  name: pg_get_viewdef_pretty
  stub: true
  sql: SELECT pg_get_viewdef(0, true)

# --- Missing tables: DBeaver queries these but duckgres doesn't have them yet ---
# These will fail until stubs are added to catalog.go.

# Role membership
- suite: dbeaver_introspection
  name: pg_auth_members
  stub: true
  sql: SELECT * FROM pg_catalog.pg_auth_members LIMIT 5

# Operator classes
- suite: dbeaver_introspection
  name: pg_opclass
  stub: true
  sql: SELECT oc.oid, oc.* FROM pg_catalog.pg_opclass AS oc LIMIT 5

# Encoding conversions
- suite: dbeaver_introspection
  name: pg_conversion
  stub: true
  sql: SELECT * FROM pg_catalog.pg_conversion AS c LIMIT 5

# Procedural languages
- suite: dbeaver_introspection
  name: pg_language
  stub: true
  sql: SELECT l.oid, l.* FROM pg_catalog.pg_language AS l

# Extensions
- suite: dbeaver_introspection
  name: pg_extension
  stub: true
  sql: SELECT e.oid, e.* FROM pg_catalog.pg_extension AS e

# Foreign servers
- suite: dbeaver_introspection
  name: pg_foreign_server
  stub: true
  sql: SELECT l.oid, l.* FROM pg_catalog.pg_foreign_server AS l

# Foreign data wrappers (with handler proc join)
- suite: dbeaver_introspection
  name: pg_foreign_data_wrapper
  stub: true
  sql: >-
    SELECT l.oid, l.*, p.pronamespace AS handler_schema_id
    FROM pg_catalog.pg_foreign_data_wrapper AS l
    LEFT JOIN pg_catalog.pg_proc AS p ON p.oid = l.fdwhandler
    ORDER BY l.fdwname

# Foreign tables
- suite: dbeaver_introspection
  name: pg_foreign_table
  stub: true
  sql: SELECT * FROM pg_catalog.pg_foreign_table LIMIT 5

# Triggers (with proc join)
- suite: dbeaver_introspection
  name: pg_trigger
  stub: true
  sql: >-
    SELECT x.oid, x.*, p.pronamespace AS func_schema_id
    FROM pg_catalog.pg_trigger AS x
    LEFT JOIN pg_catalog.pg_proc AS p ON p.oid = x.tgfoid
    LIMIT 5

# Transaction locks
- suite: dbeaver_introspection
  name: pg_locks
  stub: true
  sql: >-
    SELECT COALESCE(lock.locktype, '') AS locktype,
    lock.pid, lock.granted
    FROM pg_catalog.pg_locks AS lock
    LIMIT 5
